---
title: "PHP 2410E  - Assignment 1"
author: "Kevin W. McConeghy"
date: "Compiled: `r Sys.Date()`"
output: 
  pdf_document:
    toc: true
    toc_depth: 2
bibliography: hsrrefs.bib
link-citations: yes
params:
  code_nm: 
    value: 'hw1'
  src_cfg: 
    value: 'PHP2410E\\PHP2410E_setup.R'
always_allow_html: yes
---  
\newpage 
```{r setup, include=FALSE}
#clear
  knitr::opts_chunk$set(warning = F, message = F)
  if (Sys.getenv('USERNAME')=='kmcconeg') {
    path = 'C:\\Github\\'
  } else {
    path = '~\\Github\\'
  }

source(paste0(path, params$src_cfg))

library(knitr)
library(here)
opts_chunk$set(echo=F) 
```

# Introduction  

This is the completed assignment 1 for the ‘Medicare data’ course at Brown University.  
All code is stored in a Github repository, https://github.com/kmcconeghy/PHP2410E  

## Statement of work  

This document was created solely by the author, guidance in the homework solutions was driven by class instruction, materials or prior experience. The solutions were not shared with anyone else.  

## Note on R markdown  
This report was generated using R markdown, LaTEX, and several non-base R packages (e.g. tidyverse).  
```{r, include=F, warning=F, message=F}
pkg_load <- c('Scotty', 'tidyverse', 'rJava', 'kableExtra')

sapply(pkg_load, library, logical.return=F, warn.conflicts=F, quietly=T, character.only=T)
```
```{r, echo=F}
cat('Non-base packages loaded: ', pkg_load)
```

Assignment as written:  

 * Data Assignment #1
 * Working with Medicare Public Use Files
 * Due September 19th, 2019  

# Assignment Overview  

> CMS is committed to increasing access to its Medicare claims data through the release of de-identified data files available for public use. The first phase in this effort is the release of the 5% sample Public Use Files for a variety of Medicare claim types for the periods 2006-2014. These files are available to researchers as free downloads in CSV and/or Excel format, depending upon the year. They contain non-identifiable claim-specific information and are within the public domain.
 
> Of paramount importance in the release of Public Use Files is the protection of beneficiary confidentiality. To that end all directly identifiable information has been removed. Moreover, other potentially identifying variables, which might cause identification by themselves or enable it in combination with other variables, have either been removed from the files or their values re-coded. See the general documentation file for each claim type for specific information concerning de-identification and variable values. 

> The files can be find here: https://www.cms.gov/Research-Statistics-Data-and-Systems/Downloadable-Public-Use-Files/BSAPUFS/index.html  

> Each file has its own documentation describing file layout and variable values, as well as program code for creating SAS datasets. Click on the link in the left menu for the specific PUF to access documentation and download instructions. 

> Specification of Data Assignment
There are five possible PUF files on the CMS web site.  Each is described below. Select at least one and do the following:  

# Assigment 1.1  Infile the data  
> 1.	Read the data into a SAS or STATA analysis file using the format statement provided; 

## Public Use Files  

For this assignment the inpatient file was chosen and downloaded.  

https://www.cms.gov/Research-Statistics-Data-and-Systems/Downloadable-Public-Use-Files/BSAPUFS/Downloads/2008_BSA_Inpatient_Claims_PUF.zip

```{r }  
## File downloaded directly  
url <- 'https://www.cms.gov/Research-Statistics-Data-and-Systems/Downloadable-Public-Use-Files/BSAPUFS/Downloads/2008_BSA_Inpatient_Claims_PUF.zip'

filename <- '2008_BSA_Inpatient_Claims_PUF.csv'

temp <- tempfile()
download.file(url, temp)
df_raw <- read.csv(unz(temp, filename), header = T)
unlink(temp)
```

## Read in SAS infile statement for labels  
CMS provides a SAS infile statement for working with data, this is read in and 
used to relabel raw .csv file in R.    
```{r }
## https://stackoverflow.com/questions/33421854/how-can-i-import-sas-format-files-into-r
locf <- function(x) {
  x <- data.frame(x, stringsAsFactors = FALSE)
  x[x == ''] <- NA
  indx <- !is.na(x)
  
  x[] <- lapply(seq_along(x), function(ii) {
    idx <- cumsum(indx[, ii])
    idx[idx == 0] <- NA
    x[, ii][indx[, ii]][idx]
  })
  x[, 1]
}

fmt <- readLines(paste0(wd.data, '\\', 'BSA_Inpatient_Claims_PUF_2008_2.txt'))
## not sure if comments are allowed in the value definitions, but
## this will check for those in case
fmt <- gsub('\\*.*;|\\/\\*.*\\*\\/', '', fmt)

vars <- gsub('(?i)value\\W+(\\w*)|.', '\\1', fmt, perl = TRUE)
vars <- locf(vars)

regex <- '[\'\"].*[\'\"]|[\\w\\d-]+'
vals <- gsub(sprintf('(?i)\\s*(%s)\\s*(=)\\s*(%s)|.', regex, regex),
             '\\1\\2\\3', fmt, perl = TRUE)

dd <- na.omit(data.frame(values = vars, formats = vals,
                              stringsAsFactors = FALSE))

df_lbls <- split(dd$formats, dd$values)
df_lbls <- lapply(df_lbls, function(x) {
  x <- Filter(nzchar, x)
  x <- strsplit(x, '=')
  tw <- function(x) gsub('^\\s+|\\s+$', '', x)
  sapply(x, function(y)
    setNames(tw(y[1]), tw(y[2])))
})

df_lbls <- lapply(df_lbls, function(x) {
  new_names <- str_replace(names(x), pattern='.NA', replacement='')
  names(x) <- new_names
  return(x)
})

# Fix ICDF  
sto_names <- names(df_lbls$ICDF)
df_lbls$ICDF <- str_replace_all(df_lbls$ICDF, '[\']', '') %>%
  as.numeric(.) 
names(df_lbls$ICDF) <- sto_names  
df_lbls$ICDF <- df_lbls$ICDF[-1]
```

### Basic description of file  
```{r }
des_df(df_raw, c('Raw Inpatient PUF for 2008, downloaded from CMS'), 'IP_CLM_ID')
```
The file is one row per unique claim ID.  

### Comparison to reported statistics from website  

#### Extract table results from PDF report  
```{r }
library(tabulizer)
url = 'https://www.cms.gov/Research-Statistics-Data-and-Systems/Downloadable-Public-Use-Files/BSAPUFS/Downloads/2008_Enrollment_and_User_Rates.pdf'

lst_cms_tbls <- extract_tables(url, encoding="UTF-8") 
```

#### CMS Reported Inpatient use rates  
```{r }
cms_inpat <- lst_cms_tbls[[3]] 

colnames(cms_inpat) <- cms_inpat[1, ]
cms_inpat <- cms_inpat[-1 ,] %>%
  as_tibble(.) 

kable(cms_inpat)
```

## Data Description  

#### Sample table from codebook  
```{r }
url = 'https://www.cms.gov/Research-Statistics-Data-and-Systems/Downloadable-Public-Use-Files/BSAPUFS/Downloads/2008_BSA_Inpatient_Claims_PUF_DataDic_CB.pdf'

lst_dta_tbls <- extract_tables(url, encoding="UTF-8") 

cbook_dta_gndr <- lst_dta_tbls[[1]]

colnames(cbook_dta_gndr) <- cbook_dta_gndr[1, ]
cbook_dta_gndr <- cbook_dta_gndr[-1 ,] %>%
  as_tibble(.) 

kable(cbook_dta_gndr)
```

#### Raw data-file comparison for sex  
```{r }
df_raw$BENE_SEX_IDENT_CD %>%
  table(.)
```
The file loaded into R appears to be consistent with reported tables from CMS.    

# Assignment 1.2  Summary statistics  
> 2. 	Run summary statistics on all variables (except the ID number); this is either a frequency distribution for a nominal or ordinal variable and means, standard deviations and percentiles for the continuous variables like expenditures, etc. 

##  Summary Statistics  
First some data-formatting; rename all variables to lower string, factor categories, set the codes to character strings vs. integers.  

```{r }
## Formatting 
df_2 <- df_raw %>%
  rename_all(., tolower) %>%
  mutate(ip_clm_id = as.character(ip_clm_id),
         ip_clm_icd9_prcdr_cd = as.character(ip_clm_icd9_prcdr_cd),
         gender = factor(bene_sex_ident_cd, 
                         levels = c(1, 2),
                         labels=c('Male', 'Female')),
         age_cat = factor(bene_age_cat_cd, 
                          levels = df_lbls$AGEF,
                          labels = names(df_lbls$AGEF)),
         ip_clm_days_cd = factor(ip_clm_days_cd, 
                          levels = df_lbls$LOSF,
                          labels = names(df_lbls$LOSF)),
         ip_clm_base_drg_cd = factor(ip_clm_base_drg_cd, 
                          levels = df_lbls$DRGF,
                          labels = names(df_lbls$DRGF)),
         ip_clm_icd9_prcdr_cd = factor(ip_clm_icd9_prcdr_cd, 
                          levels = df_lbls$ICDF,
                          labels = names(df_lbls$ICDF)),
         ip_drg_quint_pmt_cd = factor(ip_drg_quint_pmt_cd)) %>%
  select(-starts_with('bene'))
```

Structure:
```{r }
str(select(df_2, -ip_clm_id))
```

### Simple Categorical variables  
```{r, }
df_2 %>%
  group_by(gender) %>%
  summarize(n = n(),
            percent = round(n() / nrow(df_2) *100, 2)) %>%
  kable(.) 

df_2 %>%
  group_by(age_cat) %>%
  summarize(n = n(),
            percent = round(n() / nrow(df_2) *100, 2)) %>%
  kable(.)

df_2 %>%
  group_by(ip_clm_days_cd) %>%
  summarize(n = n(),
            percent = round(n() / nrow(df_2) *100, 2)) %>%
  kable(.)
```

### Most DRG codes - Top 10 Codes  
```{r, }
df_2 %>%
  group_by(ip_clm_base_drg_cd) %>%
  summarize(n = n(),
            percent = round(n() / nrow(df_2) *100, 2)) %>%
  arrange(desc(n)) %>%
  slice(1:10) %>%
  kable(.)
```

### Most ICD Procedures codes - Top 10 Codes  
```{r, }
df_2 %>%
  group_by(ip_clm_icd9_prcdr_cd) %>%
  summarize(n = n(),
            percent = round(n() / nrow(df_2) *100, 2)) %>%
  arrange(desc(n)) %>%
  slice(1:10) %>%
  kable(.)
```

### DRG Payment  
```{r }
cat('Variable: ip_drg_quint_pmt_avg \n')
c(summary(df_2$ip_drg_quint_pmt_avg), 'SD' = sd(df_2$ip_drg_quint_pmt_avg)) 
```

### Payment distribution  
#### Figure 1. Distribution of Payments among Hospitalized Medicare Beneficiaries  
```{r, fig.width=6}
ggplot(df_2, aes(x = ip_drg_quint_pmt_avg)) +
  geom_histogram(bins = 100, aes(y=..density..), colour="black", fill="white") +
  geom_density(alpha=.2, fill="#FF6666") +
  xlab('Payment ($)') + ylab('Density')
```

# Assignment 1.3 Dependent variable:  
> 3.	Compare some possible dependent variable that characterizes the utilization event (length of stay in days, expenditures, cost or some other analytic variable) by age categories of your choosing and sex.  

We will use the `IP_DRG_QUINT_PMT_AVG` variable. Per the data dictionary:  

> Average Medicare total claim payment amount of the quintile for the
> payments (of a particular DRG) in the 100% Inpatient claims data for 2008.  

Restated this is the average payment for a person of equal sex, age, drg category who is in the same quintile of payment distribution as the person in this limited file. So a reasonable approximation of the payment actually sent to that person.  
```{r }
df_pay <- df_2 %>%
  group_by(gender, age_cat) %>%
  summarize(`Mean ($)` = mean(ip_drg_quint_pmt_avg),
            `SD ($)` = sd(ip_drg_quint_pmt_avg)) %>%
  mutate_at(c(3, 4), list(~prettyNum(., big.mark=',', digits=0))) %>%
  rename(Gender = gender, `Age category` = age_cat)

kable(df_pay)
```

### Figure 2. Payments (mean, log, and 95% upper threshold)  
```{r, fig.width=5, fig.height=3, fig.show='hold'}
df_g <- df_2 %>%
  group_by(gender, age_cat) %>%
  summarize(`Mean ($)` = mean(ip_drg_quint_pmt_avg),
            `Log($)` = mean(log(ip_drg_quint_pmt_avg)),
            `95% ($)` = quantile(ip_drg_quint_pmt_avg, probs=0.95)) %>%
  rename(Gender = gender)

ggplot(df_g,  aes(x = age_cat, y=`Mean ($)`, group = Gender, color=Gender)) +
  geom_line() +
  geom_point() +
  scale_color_brewer(palette="Paired") +
  xlab('Age Category') +
  theme_minimal()

ggplot(df_g,  aes(x = age_cat, y=`Log($)`, group = Gender, color=Gender)) +
  geom_line() +
  geom_point() +
  scale_color_brewer(palette="Paired") +
  xlab('Age Category') +
  theme_minimal()

ggplot(df_g,  aes(x = age_cat, y=`95% ($)`, group = Gender, color=Gender)) +
  geom_line() +
  geom_point() +
  scale_color_brewer(palette="Paired") +
  xlab('Age Category') +
  theme_minimal()
```

# Assignment 1.4 Summary Description  
> 4.	Write up the results of what you've done in no more than 3 paragraphs, referring to summary tables associated with task 2 or 3 above.  This write up should, among other things, comment on the level of skew and variation in the analytic variables like length of stay or expenditures.  

This analysis was a exploratory exercise conducted as part of a course on understanding and analyzing Medicare data for research purposes. A limited datafile which contained information on Medicare beneficiaries' hospitalizations in 2008 was downloaded from an online repository mainted by ResDAC, the data analysis center for the Center for Medicare and Medicaid Services. The file was formatted, summarized and the relationship between Avg. DRG-based payments, age and gender was evaluated in an informal exercise.  The primary research aim was to evaluate how payment rates vary by age, gender and variability of the data.  

The comma-separated file was downloaded directly  f

# Session Info  
```{r, }
sessioninfo::session_info()[[1]]
```

## Packages  
```{r }
kable(sessioninfo::session_info()[[2]])
```