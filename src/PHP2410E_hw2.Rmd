---
title: "PHP 2410E  - Assignment 2"
author: "Kevin W. McConeghy"
date: "Compiled: `r Sys.Date()`"
output: 
  pdf_document:
    toc: true
    toc_depth: 2
bibliography: hsrrefs.bib
link-citations: yes
params:
  code_nm: 
    value: 'hw2'
  src_cfg: 
    value: 'PHP2410E\\PHP2410E_setup.R'
always_allow_html: yes
---  
\newpage 
```{r setup, include=FALSE}
#clear
  knitr::opts_chunk$set(warning = F, message = F)
  if (Sys.getenv('USERNAME')=='kmcconeg') {
    path = 'C:\\Github\\'
  } else {
    path = '~\\'
  }
options(knitr.kable.NA = '')

source(paste0(path, params$src_cfg))

library(knitr)
library(here)
opts_chunk$set(echo=F) 
```

# Introduction  

This is the completed assignment 2 for the ‘Medicare data’ course at Brown University.  
All code is stored in a Github repository, https://github.com/kmcconeghy/PHP2410E  

## Statement of work  

This document was created solely by the author, guidance in the homework solutions was driven by class instruction, materials or prior experience. The solutions were not shared with anyone else.  

## Note on R markdown  
This report was generated using R markdown, LaTEX, and several non-base R packages (e.g. tidyverse).  
```{r, include=F, warning=F, message=F}
pkg_load <- c('Scotty', 'tidyverse', 'rJava', 'kableExtra')

sapply(pkg_load, library, logical.return=F, warn.conflicts=F, quietly=T, character.only=T)
```
```{r, echo=F}
cat('Non-base packages loaded: ', pkg_load)
```

Assignment as written:  

 * Data Assignment #2
 * Working with Medicare Public Use Files
 * Due October 2nd, 2019

# Assignment Overview  

> There are two data sets each containing identifying information on Medicare beneficiaries.  The information includes date of birth, gender and race.  The two sources of data are:  

> 1)	The Minimum Data Set, a clinical patient record assessment that is completed each time a patient is admitted to a nursing home in the US that is certified by Medicare/Medicaid. The MDS data file (in either STATA or SAS format) is likely to include multiple records per ID (unique individual) for many individuals;  

> 2)	The Medicare Enrollment Record is the individual identifier of every Medicare beneficiary.  The overall file includes detailed data from Social Security as well as whether and when the beneficiary had joined a Medicare Advantage Plan and when.  The current file includes only identifying information such as date of birth, gender and race.  There is only one record per person per year. The ID number on the Medicare Enrollment Record is the same as that on the MDS data file.  
 
> There are two parts to this data assignment. Each is described below. There are various ways to complete these components.  It is up to the student to choose how s/he goes about completing the assignment. 

> •	Using the MDS data determine how consistent the identifying data are across records for the same persons who have multiple records.   This means, among those with more than one record, what is the rate of inconsistency for date of birth, gender and race. DoB, gender and race have multiple ways in which they could disagree, in addition to calculating the rate of inconsistency, characterize the different ways (e.g. day, month or year of birth; missing categories of information in which this inconsistency manifests itself). (Note: The Codebook for the MDS2.0 data can be found here: https://www.cms.gov/Medicare/Quality-Initiatives-Patient-Assessment-Instruments/NursingHomeQualityInits/downloads/MDS20MDSAllForms.pdf)  

> •	Match the MDS and Medicare enrollment records based upon patient ID, using the first MDS record to match for those cases that have multiple MDS records.  Next, compare the DoB, gender and Race from the two different data sources.  Note that DoB is necessarily measured the same way across the two data sources as is gender (although there may be differing levels of missing data). The race variables across the two data sets are coded differently so it may be important to separately estimate the degree of agreement across the categories that are comparably labeled (e.g. white vs. white; black vs. black) since the Medicare Enrollment record is known to underestimate the number of Hispanic and Asian Americans.  
  
# Assessment of Minimum Dataset Assessments  

The overall objective is to better understand the validity of MDS assessments by examinining variation in patient characteristics which would typically be fixed across time (e.g. age, gender, race/ethnicity).  

## Dataset  
```{r }
df_mds <- haven::read_dta(paste0(wd.data, 'mds_select.dta')) %>%
  mutate(idrace = factor(idrace, levels=1:5, labels = c('Native-American', 'Asian', 'Black', 
                                                        'Hispanic', 'White')),
         idgendr = factor(idgendr, levels=1:2, labels = c('Male', 'Female')))

des_df(df_mds, 'MDS dataset', c('id'))
```

### Data structure  
```{r }
str(df_mds)
```

### Summary statistics  

#### Date of birth  
```{r }
summary(df_mds$idbirdt) 
```

Figure 1. Histogram of MDS date of birth  
```{r, fig.width=4, fig.height=4}
ggplot(df_mds, aes(x = idbirdt)) +
  geom_histogram(aes(y=..density..), color='navyblue',fill='blue') +
  scale_x_date() + ylab('Density') + xlab('MDS Date of Birth') +
  theme_classic()
```

#### Year  
```{r }
df_mds %>%
  mutate(year = year(dmdate)) %>%
  group_by(year) %>%
  summarize(`No. assessments` = n(),
            `No. persons` = n_distinct(id), 
            `%` = (n() / nrow(df_mds))*100) %>%
  mutate(year = factor(year)) %>%
  rename(Year = year) %>%
  kable(., digits=1, format.args=list(big.mark = ','))
```

#### Sex  
```{r }
df_mds %>%
  group_by(idgendr) %>%
  summarize(`No. assessments` = n(),
            percent = (n() / nrow(df_mds))*100) %>%
  rename(Gender = idgendr) %>%
  kable(., digits=1, format.args=list(big.mark = ','))
```

Where 1 is male and 2 is female.  

```{r }
df_mds %>%
  group_by(idrace) %>%
  summarize(`No. assessments` = n(),
            `%` = (n() / nrow(df_mds))*100) %>%
  rename(`MDS Race` = idrace) %>%
  kable(., digits=1, format.args=list(big.mark = ','))
```

#### Summary  

Median age date of birth is in 1921, most recent is in 2008 (highly suspicious for error), some dates are from early 1800s which are also in error, 302 missing DOB. The implausible dates can be set to missing as well in subsequent analyses where knowing age or date of births is important. The number of residents per year peaks in 2007. In the raw MDS file, 67% of assessments are female, 84% white, 11% Afr. American.   

> •	Using the MDS data determine how consistent the identifying data are across records for the same persons who have multiple records.   This means, among those with more than one record, what is the rate of inconsistency for date of birth, gender and race. DoB, gender and race have multiple ways in which they could disagree, in addition to calculating the rate of inconsistency, characterize the different ways (e.g. day, month or year of birth; missing categories of information in which this inconsistency manifests itself).  

Basic strategy: We recode race according to the denominator definitions. The MDS dataset will be grouped by ID, a series of flags will be generated to identify disparate records among those variables expected to be fixed.  Then the findings will be summarized in a set of tables.  

## Reformat  
```{r }
# 0 = UNKNOWN
# 1 = WHITE
# 2 = BLACK
# 3 = OTHER
# 4 = ASIAN
# 5 = HISPANIC
# 6 = NORTH AMERICAN NATIVE

df_mds_2 <- df_mds %>%
  mutate(rc_white = if_else(idrace == 5, 1L, 0L),
         rc_black = if_else(idrace == 3, 1L, 0L),
         rc_hisp = if_else(idrace == 4, 1L, 0L),
         rc_recode = case_when(
           is.na(idrace) ~ 0,
           idrace == levels(df_mds$idrace)[1] ~ 6,
           idrace == levels(df_mds$idrace)[2] ~ 4,
           idrace == levels(df_mds$idrace)[3] ~ 2,
           idrace == levels(df_mds$idrace)[4] ~ 5,
           idrace == levels(df_mds$idrace)[5] ~ 1),
         rc_recode = factor(rc_recode, levels=c(0,1,2,4,5,6), 
                            labels = c('Unknown', 'White', 'Black', 'Asian', 
                                       'Hispanic', 'North American Native')),
         female = if_else(idgendr==2, 1L, 0L),
         age = floor((dmdate - idbirdt) / 365.25)) 
```

## Consistency of data across MDS assessments  
```{r }
library(data.table) #used for computational speed  
df_mds_dups <- df_mds_2 %>%
  mutate(mon_yr = paste0(month(idbirdt), '-', year(idbirdt))) %>%
  setDT(.) %>%
  .[, by = id,
     .(`Gender` = n_distinct(idgendr, na.rm=T),
            `Race cat.`  = n_distinct(idrace, na.rm=T),
            `Race recode`  = n_distinct(rc_recode, na.rm=T),
            `DOB` = n_distinct(idbirdt, na.rm=T),
            `Birth Year-Month` = n_distinct(mon_yr, na.rm=T))] %>%
  setDF(.)

df_mds_dups[,2:6] %>%
  sapply(., factor, exclude=NULL) %>%
  summary(.) %>%
  kable(., digits=2, format.args=list(big.mark = ',')) %>% 
kable_styling(latex_options = "scale_down")
```

### Discussion  
By individual a value of 0 denotes no entries, a value of 1 or more means 1 or more distinct values for that variable (within person). There are a few missing entries but it's not the primary concern. While most only have one value, many have multiple values for the same variable (which is incoherent) and would need to be adjudicated in an analysis. In the extreme, one individual has 8 different birth dates across assessments. Birth dates may vary by a few days, or only be entered as the first of the month etc. If you recode the birth date to the month-year you may be able to collapse conflicting birthdates into the same category of month-year (`birmonyr`). This resolves about 3000 conflicted birthdates but still leaves many conflicts. Note: The summary statistics presented are by record, and multiple records per person so somewhat misleading for population inference.  

# Assessment of Medicare Enrollment File  
## Dataset  
```{r }
df_denom <- haven::read_dta(paste0(wd.data, 'denon_select.dta')) %>%
  mutate(hksex = factor(hksex, levels=1:2, labels = c('Male', 'Female')),
         hkrace = factor(hkrace, levels=c(0,1,2,4,5,6), 
                            labels = c('Unknown', 'White', 'Black', 'Asian', 
                                       'Hispanic', 'North American Native')))
des_df(df_denom, 'Denominator dataset', c('id'))
```

### Data structure  
```{r }
str(df_denom[,2:5])
```

### Summary statistics  

#### Figure 2. Denominator file date of birth  
```{r }
summary(df_denom$hkdob)
```

```{r, fig.width=4, fig.height=4}
ggplot(df_denom, aes(x = hkdob)) +
  geom_histogram(aes(y=..density..), fill='blue', color='navyblue') +
  scale_x_date() + xlab('Enrollment File Date of Birth') + ylab('Density') +
  theme_classic()
```

#### Year  
```{r }
df_denom %>%
  group_by(hkyear) %>%
  summarize(`No. records` = n(),
            `No. persons` = n_distinct(id), 
            `%`  = (n() / nrow(df_denom))*100) %>%
  rename(Year = hkyear) %>%
  mutate(Year = factor(Year)) %>%
  kable(., digits=2, format.args=list(big.mark = ','))
```
Importantly, there are no duplicates within year. Each enrollee should have one record per year.  

#### Year cross-over  
```{r }
df_denom %>%
  group_by(id) %>%
  summarize(`No. years / person` = n_distinct(hkyear)) %>%
  ungroup() %>%
  group_by(`No. years / person`) %>%
  summarize(`No. persons` = n(), 
            `%` = (n() / nrow(df_denom))*100) %>%
  mutate(`No. years / person` = factor(`No. years / person`)) %>%
  kable(., digits=2, format.args=list(big.mark = ','), align = 'ccc')
```

15% of the Medicare enrollees have been enrolled across all 11 years.   

#### Sex  
```{r }
df_denom %>%
  group_by(hksex) %>%
  summarize(`No. records` = n(),
            `%` = (n() / nrow(df_denom))*100) %>%
  rename(`Denom. Sex` = hksex) %>%
  kable(., digits=2, format.args=list(big.mark = ','))
```

```{r }
df_denom %>%
  group_by(hkrace) %>%
  summarize(`No. records` = n(),
            `%` = (n() / nrow(df_denom))*100) %>%
  rename(`Denom. Race` = hkrace) %>%
  kable(., digits=2, format.args=list(big.mark = ','))
```

## Consistency of data across enrollment years  
```{r }
df_denom_dups <- df_denom %>%
  setDT(.) %>%
  .[, by = id,
     .(`Gender` = n_distinct(hksex, na.rm=T),
            `Race cat.`  = n_distinct(hkrace, na.rm=T),
            `DOB` = n_distinct(hkdob, na.rm=T))] %>%
  setDF(.) 
  
df_denom_dups[,2:4] %>%
  sapply(., factor) %>%
  summary(.) %>%
  kable(., digits=2, format.args=list(big.mark = ','))
```

Discussion. Sex, race, and date of birth do not vary within ID number (across enrollment years).  

#### Summary description  
Median date of birth is in the 1930s (i.e. the denominator file represents younger persons than the MDS assessments). The years span 1998 - 2008, with no duplicates within year. Most recent date of birth is in 2006 (highly suspicious for error). The number of enrollees increases every year. The entire Medicare population is younger, more male, and about the same % white than the nursing home population. Note: The summary statistics presented are by record, and multiple records per person so somewhat misleading for population inference.  

# Matching MDS and Medicare file  

> Match the MDS and Medicare enrollment records based upon patient ID, using the first MDS record to match for those cases that have multiple MDS records.  Next, compare the DoB, gender and Race from the two different data sources.  Note that DoB is necessarily measured the same way across the two data sources as is gender (although there may be differing levels of missing data). The race variables across the two data sets are coded differently so it may be important to separately estimate the degree of agreement across the categories that are comparably labeled (e.g. white vs. white; black vs. black) since the Medicare Enrollment record is known to underestimate the number of Hispanic and Asian-Americans.    

Although not explicility said above, each beneficiary may have many records in the enrollment file. Particular instruction for joining wasn't given on this dimension, however as shown above the person characteristics do not vary by year so not a practical issue.  

## Prepare for matching  

### MDS record, first row per person  
```{r }
df_mds_rowone <- df_mds_2 %>%
  arrange(id) %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup() 

des_df(df_mds_rowone, 'limited to first row by person, year', 'id')
```

### Match 1:many join of first MDS assessment with denom. file  
We match one to many, than take the first row per person id 
```{r }
n_rw_lhs <- nrow(df_mds_rowone)
n_id_lhs <- n_distinct(df_mds_rowone$id)
n_rw_rhs <- nrow(df_denom)
n_id_rhs <- n_distinct(df_denom$id)

df_mtch <- inner_join(df_mds_rowone, 
                      df_denom, 
                      by=c('id')) %>%
  group_by(id) %>%
  slice(1) %>%
  ungroup()

cat('N rows, MDS file:', n_rw_lhs, 'N rows, Denom file:', n_rw_rhs, '\n')
cat('N IDs, MDS file:', n_id_lhs, 'N IDs, Denom file:', n_id_rhs, '\n')

des_df(df_mtch, 'Inner join MDS / Denom.', 'id')
```

All ID's in the MDS file had at least one matching record in the enrollment file.  

\newpage  

## Comparison of MDS and denominator data  

### Comparison of Gender  
```{r }
mytable <- xtabs(~idgendr + hksex, data=df_mtch, addNA=T)
ftable(mytable)
```

### Row percentages  
```{r }
round(prop.table(mytable, margin = 1), 3)
```

The MDS variable 'idgendr' is missing in a few cases, and is discordant in about 1.5% of cases. 1.5% where the MDS says male and enrollment says female, and 1.7% where MDS says female and enrollment says male. Note: 'NA' means missing.   

### Comparison of Race  
```{r }
mytable <- xtabs(~rc_recode + hkrace, data=df_mtch, addNA=T)
names(mytable) <- c('Unknown', 'White', 'Black', 'Other', 'Asian', 'Hispanic', 'AI')
kable(mytable, digits=2, format.args=list(big.mark = ','), align=rep('c', 7)) %>%
  add_header_above(c("MDS Race" = 1, "Medicare Enrollment Race"=7)) %>% 
kable_styling(latex_options = "scale_down")
```

Note:  The MDS race/ethnicity variable has been recoded to match categories with the enrollment file race variable. MDS missing was recoded to 0, unknown. The denominator file has a category, 'other' with no comparable category in the MDS assessment. 0 - Unknown, 1 - White, 2 - Black, 3 - Other, 4 - Asian, 5 - Hispanic, 6 - Native American.   

### Row Proportions  
```{r }
prop.table(mytable, margin = 1) %>%
  kable(., digits=2, format.args=list(big.mark = ','), align=rep('c', 7)) %>%
  add_header_above(c("MDS Race" = 1, "Medicare Enrollment Race"=7)) %>% 
kable_styling(latex_options = "scale_down")
```

There is 98% agreement between the MDS and denominator on white race (category 1), 95% on black race (cat. 2), 60% agreement on asian race (cat. 4), and poor agreement on hispanic or native american race (cat. 5, 6). Many of the individuals coded as hispanic or native american in the MDS, are listed white in the denominator file.   

## Comparison of Date of Birth  
```{r }
df_mtch_2 <- df_mtch %>%
  mutate(chk_dob = if_else(idbirdt == hkdob, 1L, 0L),
         chk_mob = if_else(month(idbirdt) == month(hkdob) &
                           year(idbirdt) == year(hkdob), 1L, 0L),
         chk_mds_gt_hk = if_else(idbirdt > hkdob, 1L, 0L),
         chk_mds_lt_hk = if_else(idbirdt < hkdob, 1L, 0L))
```

### Match by exact date of birth  
```{r }
df_mtch_2 %>%
  group_by(chk_dob) %>%
  summarize(`No. records` = n(),
            `%` = (n() / nrow(df_mtch_2))*100) %>%
  rename(`DOB match` = chk_dob) %>%
  kable(., digits=2, format.args=list(big.mark = ','))
```

The date of birth exactly matches between MDS and enrollment in 90% of cases.  

### Match by same month-year of birth  
```{r }
df_mtch_2 %>%
  group_by(chk_mob) %>%
  summarize(`No. records` = n(),
            `%` = (n() / nrow(df_mtch_2))*100) %>%
  rename(`Month of birth match` = chk_mob) %>%
  kable(., digits=2, format.args=list(big.mark = ','))
```

The month and year of birth exactly matches in 94% of cases, increasing match rate over exact date.  

### Evaluate a systematic vs. random error in date-match  
Understanding the dates do not match in a small subset of cases, one question would be: Are unmatched dates randomly different, or does one date consistently run over- under- the other?  
```{r }
df_mtch_2 %>%
  group_by(chk_mds_gt_hk) %>%
  summarize(`No. records` = n(),
            `%` = (n() / nrow(df_mtch_2))*100) %>%
  rename(`MDS DOB > Denom. DOB` = chk_mds_gt_hk) %>%
  kable(., digits=2, format.args=list(big.mark = ','))
```
```{r }
df_mtch_2 %>%
  group_by(chk_mds_lt_hk) %>%
  summarize(`No. records` = n(),
            `%` = (n() / nrow(df_mtch_2))*100) %>%
  rename(`MDS DOB < Denom. DOB` = chk_mds_lt_hk) %>%
  kable(., digits=2, format.args=list(big.mark = ','))
```
4.4% of MDS DOBs are less than the denominator file DOB, and 5% are more than the denominator DOB. So if the date of birth from CMS enrollment records is considered more valid, the MDS may be biased towards moderately younger (i.e. later) dates of birth than the actual.     

# Summary discussion  

In this assignment, two limited data files, 1) Nursing home minimum dataset assessments and 2) The Centers for Medicaid and Medicare Services enrollment file ('denominator') were summarized and joined. The primary objective was to compare how consistent reported gender/sex, race and date of birth are between the two files. To simplify the exercise the first asssesment by nursing home resident was used. The results reported above show general agreement between the two files, but some notable discrepancies for minority race categories, particularly hispanics, asians and native-americans. Dates of birth are consistent for 90% of cases outright, and the match can be improved by allowing matches by month-year instead. Overall the MDS assessments are imperfect but in reasonable agreement with the denominator file.  

# Session Info  
Thank you for taking the time to review my work!  
```{r, }
sessioninfo::session_info()[[1]]
```
